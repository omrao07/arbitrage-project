# configs/policies/risk_guard.yml
# Central risk/compliance guardrails consumed by workers & execution logic.
# All values are hard limits unless marked as "soft".
version: 1
updated: "2025-09-02T00:00:00Z"

defaults:
  # Global hard limits applied everywhere unless overridden
  max_leverage: 3.0                      # portfolio-level gross/net cap
  max_notional_per_order: 5_000_000      # USD (or book base currency)
  max_position_pct_adv: 5.0              # % of ADV per instrument
  max_daily_turnover_pct_adv: 15.0       # % ADV traded per day
  max_open_orders_per_symbol: 20
  max_cancel_replace_per_min: 30
  min_order_value: 2_000                 # block tiny dust orders
  allowed_order_types: ["limit", "marketable_limit", "ioc"]
  min_resting_ms: 500                    # throttle quote churn
  throttle_per_venue:
    default:
      max_orders_per_sec: 10
      burst: 20
    XNAS:
      max_orders_per_sec: 25
      burst: 50
  price_band_bps: 50                     # ±bps around reference (NBBO/last/mark)
  participation_cap: 0.10                # max % of live market volume
  child_order:
    max_qty_pct_remaining: 0.02          # ≤2% of remaining parent
    min_board_lot_multiple: 1            # enforce exchange board lots
  exposure:
    max_single_name_pct_nav: 3.0
    max_sector_pct_nav: 20.0
    max_country_pct_nav: 40.0
  risk_metrics:
    max_var_99_bps: 150                  # 1-day 99% VaR in bps of NAV
    max_es_97_bps: 220                   # Expected Shortfall 97.5%
  kill_switch:
    on_violation: ["child_size", "price_band", "participation", "var_breach"]
    cooloff_minutes: 15

regions:
  US:
    trading_hours: "09:30-16:00"
    price_band_bps: 30
    participation_cap: 0.12
    short_sale:
      uptick_rule: true
      enforce_locate: true
    child_order:
      min_board_lot_multiple: 1
    throttle_per_venue:
      default: { max_orders_per_sec: 15, burst: 30 }
  EU:
    trading_hours: "09:00-17:30"
    price_band_bps: 35
    participation_cap: 0.10
    mifid_best_ex:
      log_fields: ["venue", "price", "size", "ts", "policy_hash", "mask_applied"]
  IN:
    trading_hours: "09:15-15:30"
    price_band_bps: 40
    participation_cap: 0.08
    price_limits_daily_pct: 10           # circuit band reference
    child_order:
      min_board_lot_multiple: 1
  JP:
    trading_hours: "09:00-11:30,12:30-15:00"
    price_band_bps: 35
    participation_cap: 0.10
    child_order:
      min_board_lot_multiple: 100        # many JP names trade in 100-share lots

instruments:
  # Per-instrument overrides (examples)
  AAPL:
    price_band_bps: 20
    participation_cap: 0.08
    child_order: { max_qty_pct_remaining: 0.01 }
  RELIANCE.NS:
    price_band_bps: 30
    price_limits_daily_pct: 10
  7203.T:  # Toyota (TSE)
    child_order: { min_board_lot_multiple: 100 }
    participation_cap: 0.06

strategies:
  # Per-strategy risk envelopes
  stat_arb:
    max_gross_pct_nav: 120
    max_net_pct_nav: 20
    exposure: { max_single_name_pct_nav: 1.5, max_sector_pct_nav: 15 }
    risk_metrics: { max_var_99_bps: 90, max_es_97_bps: 130 }
    child_order: { max_qty_pct_remaining: 0.008 }
  momentum_ts:
    max_gross_pct_nav: 200
    max_net_pct_nav: 100
    risk_metrics: { max_var_99_bps: 140, max_es_97_bps: 200 }
  options_vol_arb:
    allowed_order_types: ["limit", "ioc"]
    max_vega_pct_nav: 5.0
    max_gamma_pct_nav: 1.0
    risk_metrics: { max_var_99_bps: 180 }
  rl_exec:   # execution agent guardrails
    participation_cap: 0.10
    price_band_bps: 25
    child_order:
      max_qty_pct_remaining: 0.01
      min_board_lot_multiple: 1
    safe_modes:
      high_volatility:
        trigger:
          sigma_intraday_bps: 250        # realized vol > 2.5%
        enforce:
          allowed_order_types: ["limit"] # disable marketable/IOC
          participation_cap: 0.05
      breaking_news:
        trigger:
          sentiment_score_max_abs: 0.8   # |score| > 0.8
        enforce:
          pause_minutes: 5

news_and_events:
  halt_on:
    - "exchange_halt"                    # trading halts
    - "limit_up_down"                    # LULD bands hit
    - "regulatory_news_high"             # e.g., 8-K, SEBI order, TSE notice
  pause_on:
    macro_releases:
      - { region: US, name: "CPI", minutes_before: 5, minutes_after: 2 }
      - { region: US, name: "NFP", minutes_before: 5, minutes_after: 2 }
      - { region: EU, name: "ECB Rate", minutes_before: 10, minutes_after: 5 }
      - { region: IN, name: "RBI Policy", minutes_before: 10, minutes_after: 5 }
      - { region: JP, name: "BoJ Statement", minutes_before: 10, minutes_after: 5 }

volatility_brakes:
  thresholds:
    sigma_intraday_bps:
      warn: 150
      hard: 300
    spread_bps:
      warn: 30
      hard: 80
    book_depth_pct_adv:
      warn: 0.5
      hard: 0.2
  actions:
    warn:
      participation_cap_multiplier: 0.5
      child_order_multiplier: 0.75
    hard:
      mode: "passive_only"               # only post inside band; no IOC/marketable
      pause_minutes: 3

compliance_logging:
  required_fields:
    - "symbol"
    - "side"
    - "qty"
    - "px_ref"
    - "px_limit"
    - "venue"
    - "ts"
    - "policy_hash"
    - "masks_applied"
  retention_days: 2555                   # ~7 years
  pii_scrub: true

evaluation:
  # Guardrails used in backtests/shadow to fail fast
  fail_if:
    slippage_bps_gt: 80                  # any single child > 80 bps vs ref
    participation_cap_breach: true
    price_band_breach: true
  degrade_to: "almgren_chiss"            # fallback policy on violation

overrides:
  # Time-bounded temporary overrides (e.g., during outages or special events)
  - name: "US FOMC lock-down"
    active_from: "2025-09-15T17:00:00Z"
    active_to:   "2025-09-15T20:00:00Z"
    region: US
    enforce:
      participation_cap: 0.03
      allowed_order_types: ["limit"]
      pause_minutes_before: 10
      pause_minutes_after: 5