# -----------------------------------------------------------------------------
# ClickHouse Operator & Installation Helm Values
# Chart: altinity/clickhouse-operator (>= 0.23.x)
# Namespace: analytics
# -----------------------------------------------------------------------------

# Override release/name
fullnameOverride: clickhouse
namespace: analytics

# -----------------------------------------------------------------------------
# Operator settings
# -----------------------------------------------------------------------------
operator:
  image: altinity/clickhouse-operator:0.23.6
  replicas: 1
  watchNamespaces: ["analytics"]
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1
      memory: 512Mi
  serviceAccount:
    create: true
    name: clickhouse-operator
    annotations: {}
      # eks.amazonaws.com/role-arn: arn:aws:iam::<ACCOUNT_ID>:role/hyper-os-sa-clickhouse
      # iam.gke.io/gcp-service-account: clickhouse@<PROJECT_ID>.iam.gserviceaccount.com

# -----------------------------------------------------------------------------
# Default ClickHouseInstallation
# -----------------------------------------------------------------------------
installation:
  enabled: true
  name: chi-analytics
  stop: false
  zookeeper:
    # Either external ZK or use embedded Keeper
    # nodes:
    #   - host: zookeeper.analytics.svc.cluster.local
    keeper:
      replicas: 3
      storage:
        size: 10Gi
        storageClass: gp3   # or "standard-rwo" on GKE
  templates:
    volumeClaimTemplates:
      - name: data
        spec:
          accessModes: [ "ReadWriteOnce" ]
          storageClassName: gp3
          resources:
            requests:
              storage: 200Gi
  configuration:
    users:
      admin/password: "clickhouse"
      admin/networks/ip: "::/0"
      readonly/password: "readonly"
      readonly/networks/ip: "::/0"
    clusters:
      - name: main
        layout:
          shardsCount: 1
          replicasCount: 2
        templates:
          podTemplates:
            - name: ch
              spec:
                serviceAccountName: clickhouse
                containers:
                  - name: clickhouse
                    image: clickhouse/clickhouse-server:24.3
                    resources:
                      requests:
                        cpu: "1"
                        memory: "4Gi"
                      limits:
                        cpu: "4"
                        memory: "12Gi"
                    volumeMounts:
                      - name: data
                        mountPath: /var/lib/clickhouse
                    readinessProbe:
                      tcpSocket: { port: 9000 }
                      initialDelaySeconds: 10
                      periodSeconds: 10
                    livenessProbe:
                      tcpSocket: { port: 9000 }
                      initialDelaySeconds: 20
                      periodSeconds: 20
                # Node selectors/tolerations if needed
                # nodeSelector: {}
                # tolerations: []
          serviceTemplates:
            - name: ch-svc
              generateName: clickhouse
              spec:
                type: ClusterIP
                ports:
                  - { name: native, port: 9000, targetPort: 9000 }
                  - { name: http,   port: 8123, targetPort: 8123 }
        settings:
          max_concurrent_queries: 64
          async_insert: 1
          async_insert_max_data_size: 10485760
          max_memory_usage: 8589934592 # 8Gi

    profiles:
      default/max_threads: 8
      default/max_memory_usage: 8589934592
      readonly/readonly: 1

    files:
      # ================================
      # Pick ONE backend (S3 or GCS)
      # ================================

      # --- S3 backup config ---
      storage.xml: |
        <clickhouse>
          <s3>
            <endpoint>s3.amazonaws.com</endpoint>
            <access_key_id>__USE_IRSA__</access_key_id>
            <secret_access_key>__USE_IRSA__</secret_access_key>
            <region>us-east-1</region>
          </s3>
          <backups>
            <s3>
              <endpoint>s3.amazonaws.com</endpoint>
              <bucket>REPLACE_S3_BUCKET_curated</bucket>
              <path>clickhouse/backups/</path>
              <compression>zstd</compression>
            </s3>
          </backups>
        </clickhouse>

      # --- GCS backup config ---
      # storage.xml: |
      #   <clickhouse>
      #     <gcs>
      #       <bucket>REPLACE_GCS_BUCKET_curated</bucket>
      #       <root>clickhouse/backups/</root>
      #     </gcs>
      #   </clickhouse>