import pandas as pd
from datetime import date
import os

OUT_PATH = "data/macro/us_gdp.csv"

def ensure_dirs(path: str):
    os.makedirs(os.path.dirname(path), exist_ok=True)

def init_us_gdp(seed: bool = True) -> pd.DataFrame:
    """
    Create us_gdp.csv with schema:
    date, gdp_usd_trn, gdp_growth_qoq, gdp_growth_yoy, source, notes
    """
    ensure_dirs(OUT_PATH)
    cols = ["date","gdp_usd_trn","gdp_growth_qoq","gdp_growth_yoy","source","notes"]

    if not seed:
        df = pd.DataFrame(columns=cols)
        df.to_csv(OUT_PATH, index=False)
        return df

    rows = [
        ("2022-12-31",25.0,0.006,0.021,"BEA","Post-COVID rebound slowing"),
        ("2023-03-31",25.4,0.016,0.027,"BEA","Consumer strength"),
        ("2023-06-30",25.9,0.020,0.030,"BEA","Inflation-driven nominal lift"),
        ("2023-09-30",26.2,0.012,0.028,"BEA","Growth moderating"),
        ("2023-12-31",26.5,0.011,0.026,"BEA","Year-end expansion"),
        ("2024-03-31",27.0,0.019,0.031,"BEA","Tech & services boost"),
        ("2024-06-30",27.4,0.015,0.029,"BEA","Balanced expansion"),
        ("2024-09-30",27.6,0.007,0.024,"BEA","Slight slowdown"),
        ("2024-12-31",27.8,0.009,0.023,"BEA","Consumer still resilient"),
        ("2025-03-31",28.2,0.014,0.025,"BEA","Q1 advance estimate"),
    ]

    df = pd.DataFrame(rows, columns=cols)
    df.to_csv(OUT_PATH, index=False)
    return df

# ---------- Analytics helpers ----------

def load_us_gdp(path: str = OUT_PATH) -> pd.DataFrame:
    df = pd.read_csv(path)
    df["date"] = pd.to_datetime(df["date"])
    return df

def annualize_growth(df: pd.DataFrame) -> pd.DataFrame:
    """
    Annualize QoQ GDP growth (approximation).
    """
    d = df.copy()
    d["gdp_growth_qoq_ann"] = (1 + d["gdp_growth_qoq"])**4 - 1
    return d

if __name__ == "__main__":
    df = init_us_gdp(seed=True)
    print(f"âœ… us_gdp.csv written to {OUT_PATH} with {len(df)} rows")
    # Example usage:
    # us = annualize_growth(load_us_gdp())
    # print(us.tail())