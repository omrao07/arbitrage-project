<!-- simulation-farm/artifacts/reports/templates/equity_curve.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ title or "Equity Curve" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js (lightweight, good defaults) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-mrrxg0l5v7m6o3eM1pGJwYVYyT9c2bT9QxgR0mN2w3t7x2QnD8b9E5i4s1pX8v2Q" crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #0b0e14; --panel: #121723; --text: #e5e9f0; --muted:#9aa4b2; --accent:#7aa2f7; --red:#f7768e; --green:#9ece6a; --yellow:#e0af68;
      --grid:#1c2233; --dd:#2b3b55;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display:flex; flex-wrap: wrap; align-items: baseline; justify-content: space-between; gap:10px; margin-bottom: 16px; }
    h1 { font-size: 22px; margin: 0; font-weight: 600; }
    .meta { color: var(--muted); font-size: 13px; display:flex; flex-wrap: wrap; gap:12px; }
    .card {
      background: var(--panel); border: 1px solid #1b2333; border-radius: 12px; padding: 14px 14px 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .stats { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .stat { background:#0f1524; border:1px solid #1b2233; border-radius:10px; padding:10px 12px; }
    .stat .k { color: var(--muted); font-size: 12px; }
    .stat .v { font-size: 18px; margin-top: 2px; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 0; }
    .btn {
      appearance:none; border:1px solid #22304a; background:#0f1524; color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:12px; cursor:pointer;
    }
    .btn:hover { border-color:#2b3a58; }
    .legend { color:var(--muted); font-size:12px; margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; }
    .legend span { display:inline-flex; align-items:center; gap:6px; }
    .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }

    canvas { width: 100% !important; height: 420px !important; }
    .foot { color:var(--muted); font-size:11px; margin-top: 8px; text-align:right; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>{{ title or "Equity Curve" }}</h1>
    <div class="meta">
      {% if run_id %}<span>Run: <strong>{{ run_id }}</strong></span>{% endif %}
      {% if strategy %}<span>Strategy: <strong>{{ strategy }}</strong></span>{% endif %}
      {% if start_date and end_date %}<span>Period: <strong>{{ start_date }} → {{ end_date }}</strong></span>{% endif %}
      {% if tz %}<span>TZ: <strong>{{ tz }}</strong></span>{% endif %}
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <canvas id="equityChart"></canvas>

      <div class="toolbar">
        <button class="btn" id="btnReset">Reset Zoom</button>
        <button class="btn" id="btnPNG">Download PNG</button>
        <button class="btn" id="btnCSV">Download CSV</button>
      </div>

      <div class="legend" id="legend">
        <!-- populated by script -->
      </div>

      <div class="foot">
        {{ footer or "Generated by Simulation Farm" }}
      </div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat">
          <div class="k">CAGR</div>
          <div class="v">{{ '%0.2f%%' % (stats.cagr * 100) if stats and stats.cagr is not none else '—' }}</div>
        </div>
        <div class="stat">
          <div class="k">Sharpe</div>
          <div class="v">{{ '%0.2f' % stats.sharpe if stats and stats.sharpe is not none else '—' }}</div>
        </div>
        <div class="stat">
          <div class="k">Sortino</div>
          <div class="v">{{ '%0.2f' % stats.sortino if stats and stats.sortino is not none else '—' }}</div>
        </div>
        <div class="stat">
          <div class="k">Max Drawdown</div>
          <div class="v">{{ '%0.2f%%' % (stats.max_drawdown * 100) if stats and stats.max_drawdown is not none else '—' }}</div>
        </div>
        <div class="stat">
          <div class="k">Win Rate</div>
          <div class="v">{{ '%0.1f%%' % (stats.win_rate * 100) if stats and stats.win_rate is not none else '—' }}</div>
        </div>
        <div class="stat">
          <div class="k">Trades</div>
          <div class="v">{{ stats.trades if stats and stats.trades is not none else '—' }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
 

  // Colors (Chart.js picks defaults; we lightly hint here)
  const COLORS = {
    equity:    'rgba(122,162,247,1)',     // accent
    bench:     'rgba(158,206,106,1)',     // green
    dd:        'rgba(43,59,85,1)',        // dark blue fill
    ddBorder:  'rgba(109,123,147,1)',
    markersBuy:  'rgba(158,206,106,1)',
    markersSell: 'rgba(247,118,142,1)'
  };

  // Build plugin for trade markers (simple scatter points)
  const tradePoints = trades.map(tr => ({ x: tr.t, y: tr.y !== undefined ? tr.y : null, side: tr.side || 'buy' }));
  function inferYForTrades() {
    // If trades don't include a y, align them to equity at that date
    const map = new Map(dates.map((d,i)=>[d, equity[i]]));
    tradePoints.forEach(p => { if (p.y === null && map.has(p.x)) p.y = map.get(p.x); });
  }
  inferYForTrades();

  // Compose datasets
  const datasets = [
    {
      label: 'Equity',
      data: dates.map((d,i)=>({x:d, y: equity[i]})),
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.15,
      yAxisID: 'y',
    }
  ];
  if (benchmark) {
    datasets.push({
      label: 'Benchmark',
      data: dates.map((d,i)=>({x:d, y: benchmark[i]})),
      borderWidth: 1.5,
      borderDash: [4,3],
      pointRadius: 0,
      tension: 0.1,
      yAxisID: 'y',
    });
  }
  if (drawdown) {
    datasets.push({
      label: 'Drawdown',
      data: dates.map((d,i)=>({x:d, y: drawdown[i] * 100})), // as %
      type: 'line',
      fill: 'origin',
      yAxisID: 'y1',
      borderWidth: 1,
    });
  }

  // Add trade marker dataset (scatter)
  if (tradePoints.length > 0) {
    datasets.push({
      label: 'Trades',
      type: 'scatter',
      data: tradePoints,
      yAxisID: 'y',
      pointRadius: 3,
      showLine: false,
      parsing: { xAxisKey: 'x', yAxisKey: 'y' },
      segment: { borderWidth: 0 },
      pointBackgroundColor: ctx => (ctx.raw && ctx.raw.side === 'sell') ? COLORS.markersSell : COLORS.markersBuy,
      pointBorderColor: ctx => (ctx.raw && ctx.raw.side === 'sell') ? COLORS.markersSell : COLORS.markersBuy,
      tooltip: {
        callbacks: {
          label: ctx => {
            const r = ctx.raw || {};
            return (r.side ? r.side.toUpperCase() : 'TRADE') + (r.px ? ` @ ${r.px}` : '') + (r.qty ? ` x ${r.qty}` : '');
          }
        }
      }
    });
  }

  // Chart config
  const ctx = document.getElementById('equityChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#c8d0dc' }
        },
        y: {
          position: 'left',
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#c8d0dc' },
          title: { display: true, text: 'Equity', color: '#c8d0dc' }
        },
        y1: {
          position: 'right',
          grid: { display:false },
          ticks: {
            color: '#c8d0dc',
            callback: v => v + '%'
          },
          title: { display: true, text: 'Drawdown', color: '#c8d0dc' },
          suggestedMax: 0,  // drawdown is ≤ 0%
          suggestedMin: -100
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              if (ctx.dataset.label === 'Drawdown') return `Drawdown: ${ctx.parsed.y.toFixed(2)}%`;
              const v = ctx.parsed.y;
              return `${ctx.dataset.label}: ${v.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
            }
          }
        }
      },
      elements: {
        line: {
          borderColor: (ctx) => {
            const label = ctx.dataset?.label;
            if (label === 'Equity') return COLORS.equity;
            if (label === 'Benchmark') return COLORS.bench;
            if (label === 'Drawdown') return COLORS.ddBorder;
            return undefined;
          },
          backgroundColor: (ctx) => {
            const label = ctx.dataset?.label;
            if (label === 'Drawdown') return 'rgba(43,59,85,0.35)';
            return 'transparent';
          }
        },
        point: { radius: 0 }
      }
    }
  });

  // Custom legend
  const legend = document.getElementById('legend');
  function swatch(color, text) {
    const span = document.createElement('span');
    const box = document.createElement('span');
    box.className = 'swatch'; box.style.background = color;
    span.appendChild(box);
    span.appendChild(document.createTextNode(text));
    return span;
  }
  legend.appendChild(swatch(COLORS.equity, 'Equity'));
  if (benchmark) legend.appendChild(swatch(COLORS.bench, 'Benchmark'));
  if (drawdown) legend.appendChild(swatch('linear-gradient(180deg, rgba(109,123,147,1), rgba(43,59,85,0.35))', 'Drawdown'));
  if (tradePoints.length) legend.appendChild(swatch('conic-gradient(from 0deg, '+COLORS.markersBuy+', '+COLORS.markersSell+')', 'Trades'));

  // Toolbar actions
  document.getElementById('btnReset').onclick = () => {
    chart.resetZoom ? chart.resetZoom() : chart.update();
  };

  
  document.getElementById('btnCSV').onclick = () => {
    const lines = ['date,equity' + (benchmark ? ',benchmark' : '') + (drawdown ? ',drawdown_pct' : '')];
    for (let i=0; i<dates.length; i++) {
      const cols = [dates[i], equity[i]];
      if (benchmark) cols.push(benchmark[i]);
      if (drawdown) cols.push((drawdown[i]*100).toFixed(4));
      lines.push(cols.join(','));
    }
    const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'equity_curve.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
</script>

<!-- Time scale adapter (date-fns) for Chart.js time axis -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</body>
</html>